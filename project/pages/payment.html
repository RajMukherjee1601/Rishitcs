<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pay Bill • PMS</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <div class="topbar">
    <div class="container">
      <nav class="nav">
        <a href="../pages/login.html" data-page="login">Login</a>
        <a href="../pages/register.html" data-page="register" data-role-only="customer">Register</a>

        <a href="../pages/customer-home.html" data-page="customer-home" data-role-only="customer">Home (Customer)</a>
        <a href="../pages/officer-home.html" data-page="officer-home" data-role-only="officer">Home (Officer)</a>

        <a href="../pages/booking-customer.html" data-page="booking-customer" data-role-only="customer">Booking Service</a>
        <a href="../pages/booking-officer.html" data-page="booking-officer" data-role-only="officer">Booking Service</a>

        <a href="../pages/tracking-customer.html" data-page="tracking-customer" data-role-only="customer">Tracking</a>
        <a href="../pages/tracking-officer.html" data-page="tracking-officer" data-role-only="officer">Tracking</a>

        <a href="../pages/booking-history-customer.html" data-page="history-customer" data-role-only="customer">Previous Booking</a>
        <a href="../pages/booking-history-officer.html" data-page="history-officer" data-role-only="officer">Booking History</a>

        <a href="../pages/pickup-scheduling.html" data-page="pickup" data-role-only="officer">Pickup Scheduling</a>
        <a href="../pages/delivery-update.html" data-page="delivery" data-role-only="officer">Delivery Update</a>

        <a href="../pages/support.html" data-page="support">Contact Support</a>

        <div class="right">
          <span id="welcomeUser" class="muted"></span>
          <button id="logoutBtn" class="btn-secondary">Logout</button>
        </div>
      </nav>
    </div>
  </div>

  <main class="container grid">
    <div id="alertHost"></div>
    
<section class="card">
  <h1>Pay Bill</h1>
  <p class="muted">Bill Amount (read-only), choose Mode of Payment (Debit/Credit) → Pay Now → enter card details → Make Payment.</p>
  <hr />

  <div class="grid">
    <div class="card" style="padding:14px">
      <h2>Payment Summary</h2>
      <div class="form-grid">
        <div>
          <label class="muted">Bill Amount (₹)</label><br />
          <input id="billAmount" readonly />
        </div>
        <div>
          <label class="muted">Mode of Payment</label><br />
          <select id="mode">
            <option value="debit">Debit</option>
            <option value="credit" selected>Credit</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="payNowBtn" class="btn">Pay Now</button>
        <button id="backBtn" class="btn-secondary">Back to Booking Service</button>
      </div>
    </div>

    <div id="cardBox" class="card" style="padding:14px;display:none">
      <h2>Enter Card Details</h2>
      <div class="form-grid">
        <div>
          <label class="muted">Card Type</label><br />
          <input value="Credit Card" readonly />
        </div>
        <div>
          <label class="muted">Card No (16 digits)</label><br />
          <input id="cardNo" inputmode="numeric" maxlength="16" placeholder="1234123412341234" />
        </div>
        <div>
          <label class="muted">Card Holder Name</label><br />
          <input id="cardName" placeholder="Name on card" />
        </div>
        <div>
          <label class="muted">Expiry Date (MM/YY)</label><br />
          <input id="exp" placeholder="08/28" maxlength="5" />
        </div>
        <div>
          <label class="muted">CVV (3 digits)</label><br />
          <input id="cvv" inputmode="numeric" maxlength="3" placeholder="123" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="makePayBtn" class="btn">Make Payment</button>
      </div>
      <p class="muted" style="margin-top:10px">On success: show “Payment Successful” + Booking ID and redirect to Invoice page.</p>
    </div>
  </div>
</section>

    <div class="footer">Parcel Management System UI • HTML/CSS/JS (localStorage demo)</div>
  </main>

  <script src="../assets/app.js"></script>
  <script>
    ensureSeed();
    const __page = "payment";
    // login/register don't require auth
    if(!["login","register"].includes(__page)) {
      requireAuth();
    }
    setupNav(__page);
  </script>
  
<script>
  const s = requireAuth();
  const draft = load("pms_current_booking_draft_v1", null);
  if(!draft){
    toast("No booking draft found. Please create a booking first.", "danger");
  }
  document.getElementById("billAmount").value = draft?.payment?.amount ?? "";

  document.getElementById("backBtn").addEventListener("click", ()=>{
    if(s.role === "customer") location.href = "../pages/booking-customer.html";
    else location.href = "../pages/booking-officer.html";
  });

  document.getElementById("payNowBtn").addEventListener("click", ()=>{
    document.getElementById("cardBox").style.display = "block";
  });

  document.getElementById("makePayBtn").addEventListener("click", ()=>{
    const cardNo = document.getElementById("cardNo").value.trim();
    const name = document.getElementById("cardName").value.trim();
    const exp = document.getElementById("exp").value.trim();
    const cvv = document.getElementById("cvv").value.trim();

    if(!/^[0-9]{16}$/.test(cardNo)) return toast("Card No must be 16 digits.", "danger");
    if(!name) return toast("Card Holder Name is required.", "danger");
    if(!/^[0-1][0-9]\/\d{2}$/.test(exp) || exp.slice(0,2) === "00" || parseInt(exp.slice(0,2),10) > 12){
      return toast("Expiry Date must be MM/YY.", "danger");
    }
    if(!/^[0-9]{3}$/.test(cvv)) return toast("CVV must be 3 digits.", "danger");

    const bookingId = generateBookingId();
    const paidAt = new Date().toISOString();

    const record = {
      bookingId,
      bookingDate: new Date().toISOString(),
      createdByRole: draft.createdByRole,
      customerId: draft.customerId || (s.role==="customer" ? s.userId : null),
      sender: draft.sender,
      receiver: draft.receiver,
      parcel: draft.parcel,
      shipping: draft.shipping,
      services: draft.services,
      payment: {
        ...draft.payment,
        mode: document.getElementById("mode").value,
        paidAt
      },
      status: "Picked up", // default after payment (officer can update later too)
      pickupScheduledAt: null
    };

    const all = bookings();
    all.unshift(record);
    saveBookings(all);

    save("pms_last_paid_booking_id_v1", bookingId);
    localStorage.removeItem("pms_current_booking_draft_v1");

    toast(`Payment Successful. Booking ID: ${bookingId}`, "ok");
    setTimeout(()=> location.href = "../pages/invoice.html", 700);
  });
</script>

</body>
</html>
