<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking History (Officer) • PMS</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <div class="topbar">
    <div class="container">
      <nav class="nav">
        <a href="../pages/login.html" data-page="login">Login</a>
        <a href="../pages/register.html" data-page="register" data-role-only="customer">Register</a>

        <a href="../pages/customer-home.html" data-page="customer-home" data-role-only="customer">Home (Customer)</a>
        <a href="../pages/officer-home.html" data-page="officer-home" data-role-only="officer">Home (Officer)</a>

        <a href="../pages/booking-customer.html" data-page="booking-customer" data-role-only="customer">Booking Service</a>
        <a href="../pages/booking-officer.html" data-page="booking-officer" data-role-only="officer">Booking Service</a>

        <a href="../pages/tracking-customer.html" data-page="tracking-customer" data-role-only="customer">Tracking</a>
        <a href="../pages/tracking-officer.html" data-page="tracking-officer" data-role-only="officer">Tracking</a>

        <a href="../pages/booking-history-customer.html" data-page="history-customer" data-role-only="customer">Previous Booking</a>
        <a href="../pages/booking-history-officer.html" data-page="history-officer" data-role-only="officer">Booking History</a>

        <a href="../pages/pickup-scheduling.html" data-page="pickup" data-role-only="officer">Pickup Scheduling</a>
        <a href="../pages/delivery-update.html" data-page="delivery" data-role-only="officer">Delivery Update</a>

        <a href="../pages/support.html" data-page="support">Contact Support</a>

        <div class="right">
          <span id="welcomeUser" class="muted"></span>
          <button id="logoutBtn" class="btn-secondary">Logout</button>
        </div>
      </nav>
    </div>
  </div>

  <main class="container grid">
    <div id="alertHost"></div>
    
<section class="card">
  <h1>Booking History (Officer)</h1>
  <p class="muted">Search bookings by Customer ID and Date Range. Includes Previous / Next pagination.</p>
  <hr />

  <div class="form-grid">
    <div>
      <label class="muted">Customer ID</label><br />
      <input id="cid" placeholder="customer01" />
    </div>
    <div>
      <label class="muted">From Date</label><br />
      <input id="from" type="date" />
    </div>
    <div>
      <label class="muted">To Date</label><br />
      <input id="to" type="date" />
    </div>
    <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
      <button id="filterBtn" class="btn">Filter</button>
      <button id="resetBtn" class="btn-secondary">Reset</button>
    </div>
  </div>

  <div id="tableBox" style="margin-top:14px"></div>

  <div class="row" style="margin-top:12px">
    <button id="prevBtn" class="btn-secondary">Previous</button>
    <button id="nextBtn" class="btn-secondary">Next</button>
  </div>
</section>

    <div class="footer">Parcel Management System UI • HTML/CSS/JS (localStorage demo)</div>
  </main>

  <script src="../assets/app.js"></script>
  <script>
    ensureSeed();
    const __page = "history-officer";
    // login/register don't require auth
    if(!["login","register"].includes(__page)) {
      requireAuth();
    }
    setupNav(__page);
  </script>
  
<script>
  const s = requireAuth();
  if(s?.role !== "officer") location.href = "../pages/booking-history-customer.html";

  const PAGE_SIZE = 6;
  let page = 0;
  let current = [];

  function applyFilters(){
    const cid = document.getElementById("cid").value.trim().toLowerCase();
    const from = document.getElementById("from").value;
    const to = document.getElementById("to").value;

    let list = bookings().slice().sort((a,b)=> new Date(b.bookingDate)-new Date(a.bookingDate));

    if(cid) list = list.filter(b => (b.customerId||"").toLowerCase() === cid);
    if(from){
      const f = new Date(from+"T00:00:00");
      list = list.filter(b => new Date(b.bookingDate) >= f);
    }
    if(to){
      const t = new Date(to+"T23:59:59");
      list = list.filter(b => new Date(b.bookingDate) <= t);
    }

    current = list;
    page = 0;
    render();
  }

  function render(){
    const start = page * PAGE_SIZE;
    const slice = current.slice(start, start+PAGE_SIZE);

    const box = document.getElementById("tableBox");
    if(!current.length){
      box.innerHTML = '<p class="muted">No bookings found for the selected filters.</p>';
      document.getElementById("prevBtn").disabled = true;
      document.getElementById("nextBtn").disabled = true;
      return;
    }

    box.innerHTML = `
      <div class="card" style="padding:0;overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th>Booking ID</th>
              <th>Customer ID</th>
              <th>Booking Date</th>
              <th>Receiver Name</th>
              <th>Delivered Address</th>
              <th>Amount</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${slice.map(b=>`
              <tr>
                <td>${escapeHtml(b.bookingId)}</td>
                <td>${escapeHtml(b.customerId || "-")}</td>
                <td class="muted">${escapeHtml(new Date(b.bookingDate).toLocaleString())}</td>
                <td>${escapeHtml(b.receiver.name)}</td>
                <td>${escapeHtml(b.receiver.address)}</td>
                <td>₹ ${escapeHtml(b.payment.amount)}</td>
                <td><span class="badge ${b.status==='Delivered'?'ok':(b.status==='Returned'?'danger':'warn')}">${escapeHtml(b.status)}</span></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:10px">Showing ${start+1}-${Math.min(start+PAGE_SIZE, current.length)} of ${current.length}</p>
    `;

    document.getElementById("prevBtn").disabled = page === 0;
    document.getElementById("nextBtn").disabled = (start+PAGE_SIZE) >= current.length;
  }

  document.getElementById("filterBtn").addEventListener("click", applyFilters);
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    document.getElementById("cid").value = "";
    document.getElementById("from").value = "";
    document.getElementById("to").value = "";
    current = bookings().slice().sort((a,b)=> new Date(b.bookingDate)-new Date(a.bookingDate));
    page = 0; render();
  });

  document.getElementById("prevBtn").addEventListener("click", ()=>{ page = Math.max(0, page-1); render(); });
  document.getElementById("nextBtn").addEventListener("click", ()=>{ page += 1; render(); });

  // init
  current = bookings().slice().sort((a,b)=> new Date(b.bookingDate)-new Date(a.bookingDate));
  render();
</script>

</body>
</html>
